# KurweBall — Context Summary

## Session Summary
- **Date**: 2026-02-13 (~2:10 PM - 2:40 PM)
- **Project**: KurweBall — Unified Recruiting Platform (ATS + CRM)
- **Location**: `C:\Outlook Claude\Kurweball`
- **Branch**: master, latest commit: `b446acb`

### Accomplished This Session
1. **Configurable Role Permissions System** (FULLY IMPLEMENTED):
   - Added `RolePermission` Prisma model (per-tenant, per-role, JSON permissions array)
   - Created `role-permissions` API module (service + controller + module) with GET/PUT endpoints
   - JWT strategy fetches effective permissions from DB, attaches to user object
   - RolesGuard checks `user.permissions[]` with hardcoded fallback
   - Frontend `usePermissions` hook checks DB-backed permissions from `/auth/me`
   - Interactive roles page: admins toggle MANAGER/RECRUITER permissions, save/reset buttons
   - ADMIN and VIEWER roles remain locked (non-customizable)
   - Migration: `20260213190951_add_role_permissions`

2. **Logo Unification**:
   - Replaced letter "K" with filled Circle (ball) icon on landing page (navbar + footer)
   - Updated sidebar logo to match landing page (gradient bg, ball icon, "Ball" in indigo-400, h-9 w-9)

3. **Bug Fix — Infinite fetchInvites loop**:
   - `can` function recreated every render → useEffect infinite loop → rate limiter (429)
   - Fixed by extracting `can("users:read")` to stable boolean before useEffect dependency

### What Needs To Be Done Next
1. User asked to "perform multiple tasks at once" — need to ask what tasks
2. Take screenshots of team page and roles page (user requested)
3. User reported invite link `ERR_CONNECTION_REFUSED` — was during server restart, now working
4. Deploy to Hetzner (SSH port needs whitelisting — see memory/deployment-status.md)

### Key Decisions
- RolePermission uses JSON array (not junction table) for simplicity
- ADMIN/VIEWER always hardcoded, only MANAGER/RECRUITER customizable
- Fallback to hardcoded permissions if no DB record exists (zero-migration safe)

## Technical State

### Files Created This Session
- `apps/api/prisma/migrations/20260213190951_add_role_permissions/migration.sql`
- `apps/api/src/modules/role-permissions/role-permissions.service.ts`
- `apps/api/src/modules/role-permissions/role-permissions.controller.ts`
- `apps/api/src/modules/role-permissions/role-permissions.module.ts`

### Files Modified This Session
- `apps/api/prisma/schema.prisma` — Added RolePermission model + Tenant relation
- `apps/api/src/app.module.ts` — Import RolePermissionsModule
- `apps/api/src/modules/auth/auth.module.ts` — Import RolePermissionsModule
- `apps/api/src/modules/auth/strategies/jwt.strategy.ts` — Inject RolePermissionsService
- `apps/api/src/modules/auth/rbac/roles.guard.ts` — Check user.permissions array
- `apps/web/src/stores/auth-store.ts` — Added permissions to AuthUser
- `apps/web/src/hooks/use-permissions.ts` — Check DB-backed permissions
- `apps/web/src/app/(dashboard)/roles/page.tsx` — Full rewrite: interactive toggle UI
- `apps/web/src/app/(dashboard)/team/page.tsx` — Fix infinite fetchInvites loop
- `apps/web/src/app/page.tsx` — Replace K with Circle icon
- `apps/web/src/components/layout/sidebar.tsx` — Match landing page logo exactly

### New API Endpoints
- `GET /api/role-permissions` — All roles with effective permissions (requires settings:read)
- `GET /api/role-permissions/:role` — Single role permissions (requires settings:read)
- `PUT /api/role-permissions/:role` — Update MANAGER/RECRUITER permissions (requires settings:update)

### Architecture: Permission Check Flow
JWT validate → RolePermissionsService.getEffectivePermissions(tenantId, role) → user.permissions[] → RolesGuard checks user.permissions / frontend usePermissions checks user.permissions

### Build Status
- Frontend: port 3000 (Next.js with Turbopack)
- API: port 3001 (NestJS)
- TypeScript: API has zero new errors; Frontend has zero errors
- Git: master branch, commit `b446acb`, pushed to origin

### Database
- 3 users: Anvesh (ADMIN), Sarah (RECRUITER), Mike (RECRUITER)
- 2 pending invites: saikumar (MANAGER), Hr (MANAGER)
- Admin login: anvesh.n@engineeringsquare.us / Admin123$

## Resume Instructions
1. Read this file + `memory/MEMORY.md`
2. Start API: `cd apps/api && node --require @swc-node/register src/main.ts`
3. Start frontend: `cd Kurweball && npm run dev -w web`
4. Both servers: API on 3001, frontend on 3000
5. Ask user what multiple tasks they want done in parallel
6. Invite links: `localhost:3000/register?token=<token>` — works when frontend is running
