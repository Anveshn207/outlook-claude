# Kurweball — Context Summary

## Session Summary
- **Date**: 2026-02-12 (afternoon session — Sprint 9 + Error Handling + Security)
- **Project**: Kurweball — Unified Recruiting Platform (ATS + CRM)
- **Location**: `C:\Outlook Claude\Kurweball`

### Accomplished This Session

**Sprint 9 COMPLETE** (6 features, ~34 new files, ~30 modified):
1. RBAC (4 roles, global guard, @RequirePermissions on all 14+ controllers, frontend permission mirror)
2. SSE Real-Time Notifications (replaces 30s polling)
3. Email Notifications (Nodemailer, graceful skip without SMTP)
4. Bulk Actions (candidates/jobs/clients select + bulk status/delete)
5. UI Polish (skeletons, toaster, error boundary, mobile responsiveness)
6. Deployment (Docker multi-stage, Caddy, docker-compose.prod.yml, deploy.sh)

**Production Error Handling COMPLETE**:
- Global exception filter → structured `{ success, error: { code, message, details, referenceId } }`
- Request logging middleware with sensitive field sanitization
- Rate limiting (@nestjs/throttler: 100/min global, 5/min login, 3/min register)
- JWT error handling (expired, invalid, malformed)
- Frontend: enhanced ApiError, api-error-handler with toast, global-error.tsx

**Red Team Security Audit COMPLETE** (46 findings):
- Fixed 6 CRITICAL (path traversal, XSS×2, file validation×2, email template XSS)
- Fixed 7 HIGH (sortBy/sortOrder validation, role enum, SSE leak, bulk array limits)
- Fixed 11 IMPORTANT (URL validation, alert→toast, auth header, link validation)
- 2 CRITICAL architectural items noted but not fixed (open registration, JWT in localStorage)

### What Needs to Be Done Next (Prioritized)
1. **Invite system** — Replace open registration with invite tokens (CRITICAL security)
2. **httpOnly cookie auth** — Move JWT from localStorage to httpOnly cookies (CRITICAL)
3. **Refresh token rotation** — Store in DB, invalidate on use (HIGH)
4. **Permission gates** — Add `can()` to interviews/tasks/reports/pipeline/notifications/search/import pages
5. **Password change flow** — Current + new password endpoint
6. **ENV validation wiring** — Connect env.validation.ts to ConfigModule
7. **Deploy to Hetzner** — Run deploy.sh with proper .env.production

### Key Decisions
- SSE over WebSocket (one-way push, simpler, built into NestJS)
- Fetch-based SSE client (not EventSource — needs Authorization header)
- Direct nodemailer (not @nestjs-modules/mailer — minimal deps)
- Global RolesGuard via APP_GUARD (passthrough for unannotated routes)
- Frontend permission mirror (avoids API calls for UI conditionals)
- Multi-stage Docker builds for minimal image size

## Technical State

### New Files This Session
**Error Handling:**
- `apps/api/src/common/filters/global-exception.filter.ts`
- `apps/api/src/common/filters/index.ts`
- `apps/api/src/common/middleware/request-logger.middleware.ts`
- `apps/api/src/common/middleware/index.ts`
- `apps/web/src/lib/api-error-handler.ts`
- `apps/web/src/app/global-error.tsx`

**Sprint 9 (see memory/kurweball-progress.md for full list)**

### Dependencies Added
- `@nestjs/throttler` (rate limiting)
- `nodemailer` + `@types/nodemailer` (email)
- `@radix-ui/react-checkbox` + `@radix-ui/react-alert-dialog` (shadcn components)

### Build Status
- Frontend: CLEAN (zero TS errors, Next.js build passes all 20 routes)
- API: CLEAN (pre-existing errors in import-export + interviews only)
- Sprints 1-9 COMPLETE, 18 API modules, ~235 files

### Running Services
- API: `cd apps/api && node --require @swc-node/register src/main.ts` (port 3001)
- Frontend: `cd apps/web && npm run dev` (port 3000)
- Login: admin@acme.com / password123

## Resume Instructions
1. Read this file + `memory/kurweball-progress.md`
2. Priority: implement invite system (open registration is CRITICAL security gap)
3. Then: httpOnly cookie auth, refresh token rotation, page permission gates
4. Verify builds: `npx tsc --noEmit` in both apps/api and apps/web
