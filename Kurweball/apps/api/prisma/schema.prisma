generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum UserRole {
  ADMIN
  RECRUITER
  MANAGER
  VIEWER
}

enum CandidateSource {
  REFERRAL
  LINKEDIN
  JOBBOARD
  DIRECT
  OTHER
}

enum CandidateStatus {
  ACTIVE
  PASSIVE
  DND
  PLACED
}

enum RateType {
  HOURLY
  ANNUAL
}

enum JobType {
  FULLTIME
  CONTRACT
  C2H
}

enum JobStatus {
  OPEN
  CLOSED
  ON_HOLD
  FILLED
}

enum JobPriority {
  HOT
  NORMAL
  LOW
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  PROSPECT
}

enum SubmissionStatus {
  SUBMITTED
  SHORTLISTED
  INTERVIEW
  OFFERED
  PLACED
  REJECTED
  WITHDRAWN
}

enum InterviewType {
  PHONE_SCREEN
  TECHNICAL
  ONSITE
  PANEL
  FINAL
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum ActivityType {
  NOTE
  CALL
  EMAIL
  MEETING
  STATUS_CHANGE
  SUBMISSION
}

enum TaskPriority {
  HIGH
  MEDIUM
  LOW
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CustomFieldType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTI_SELECT
  CHECKBOX
  URL
  EMAIL
  PHONE
  CURRENCY
}

enum NotificationType {
  SUBMISSION_UPDATE
  INTERVIEW_SCHEDULED
  TASK_ASSIGNED
  TASK_DUE
  STAGE_CHANGE
  NEW_CANDIDATE
  SYSTEM
}

// ─── Models ──────────────────────────────────────────────────────────────────

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  createdAt DateTime @default(now())

  users           User[]
  candidates      Candidate[]
  jobs            Job[]
  clients         Client[]
  contacts        Contact[]
  submissions     Submission[]
  interviews      Interview[]
  resumes         Resume[]
  attachments     Attachment[]
  activities      Activity[]
  tasks           Task[]
  customFields    CustomField[]
  savedViews      SavedView[]
  pipelineTemplates PipelineTemplate[]
  notifications     Notification[]
  inviteTokens      InviteToken[]
  rolePermissions   RolePermission[]

  @@map("tenants")
}

model User {
  id           String   @id @default(cuid())
  tenantId     String
  email        String
  passwordHash String
  firstName    String
  lastName     String
  role         UserRole @default(RECRUITER)
  avatarUrl    String?
  isActive            Boolean  @default(true)
  emailNotifications  Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  candidatesCreated    Candidate[]           @relation("CandidateCreatedBy")
  jobsCreated          Job[]                 @relation("JobCreatedBy")
  clientsCreated       Client[]              @relation("ClientCreatedBy")
  submissionsSubmitted Submission[]          @relation("SubmissionSubmittedBy")
  stageHistoryMoves    SubmissionStageHistory[] @relation("StageMovedBy")
  interviewsCreated    Interview[]           @relation("InterviewCreatedBy")
  attachmentsUploaded  Attachment[]          @relation("AttachmentUploadedBy")
  activitiesCreated    Activity[]            @relation("ActivityCreatedBy")
  tasksAssigned        Task[]                @relation("TaskAssignedTo")
  tasksCreated         Task[]                @relation("TaskCreatedBy")
  savedViews           SavedView[]           @relation("SavedViewCreatedBy")
  notifications        Notification[]
  invitesCreated       InviteToken[]         @relation("InviteCreatedBy")
  refreshTokens        RefreshToken[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@map("users")
}

model Candidate {
  id              String          @id @default(cuid())
  tenantId        String
  applicantId     String?
  firstName       String
  lastName        String
  email           String?
  phone           String?
  source          CandidateSource @default(OTHER)
  status          CandidateStatus @default(ACTIVE)
  title           String?
  currentEmployer String?
  location        String?
  state           String?
  visaStatus      String?
  linkedinUrl     String?
  rate            Decimal?
  rateType        RateType?
  availability    String?
  dateOfBirth     DateTime?
  resumeAvailable String?
  skills          String[]
  tags            String[]
  customData      Json            @default("{}")
  createdById     String
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy  User     @relation("CandidateCreatedBy", fields: [createdById], references: [id])

  submissions Submission[]
  interviews  Interview[]
  resumes     Resume[]

  @@index([tenantId])
  @@map("candidates")
}

model Job {
  id                 String      @id @default(cuid())
  tenantId           String
  clientId           String
  contactId          String?
  title              String
  description        String?
  requirements       String?
  location           String?
  jobType            JobType     @default(FULLTIME)
  status             JobStatus   @default(OPEN)
  positionsCount     Int         @default(1)
  billRate           Decimal?
  payRate            Decimal?
  priority           JobPriority @default(NORMAL)
  skillsRequired     String[]
  pipelineTemplateId String?
  customData         Json        @default("{}")
  createdById        String
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client           Client            @relation(fields: [clientId], references: [id])
  contact          Contact?          @relation(fields: [contactId], references: [id])
  pipelineTemplate PipelineTemplate? @relation(fields: [pipelineTemplateId], references: [id])
  createdBy        User              @relation("JobCreatedBy", fields: [createdById], references: [id])

  submissions Submission[]
  interviews  Interview[]

  @@index([tenantId])
  @@map("jobs")
}

model Client {
  id         String       @id @default(cuid())
  tenantId   String
  name       String
  industry   String?
  website    String?
  address    String?
  city       String?
  state      String?
  country    String?
  status     ClientStatus @default(ACTIVE)
  notes      String?
  customData Json         @default("{}")
  createdById String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User      @relation("ClientCreatedBy", fields: [createdById], references: [id])

  contacts Contact[]
  jobs     Job[]

  @@index([tenantId])
  @@map("clients")
}

model Contact {
  id        String   @id @default(cuid())
  tenantId  String
  clientId  String
  firstName String
  lastName  String
  email     String?
  phone     String?
  title     String?
  isPrimary Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  jobs Job[]

  @@index([tenantId])
  @@index([clientId])
  @@map("contacts")
}

model Submission {
  id             String           @id @default(cuid())
  tenantId       String
  candidateId    String
  jobId          String
  submittedById  String
  status         SubmissionStatus @default(SUBMITTED)
  submittedAt    DateTime         @default(now())
  payRate        Decimal?
  billRate       Decimal?
  notes          String?
  currentStageId String?
  customData     Json             @default("{}")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  tenant       Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  candidate    Candidate      @relation(fields: [candidateId], references: [id])
  job          Job            @relation(fields: [jobId], references: [id])
  submittedBy  User           @relation("SubmissionSubmittedBy", fields: [submittedById], references: [id])
  currentStage PipelineStage? @relation(fields: [currentStageId], references: [id])

  stageHistory SubmissionStageHistory[]
  interviews   Interview[]

  @@unique([tenantId, jobId, candidateId])
  @@index([tenantId])
  @@map("submissions")
}

model PipelineTemplate {
  id        String  @id @default(cuid())
  tenantId  String
  name      String
  isDefault Boolean @default(false)

  tenant Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  stages PipelineStage[]
  jobs   Job[]

  @@index([tenantId])
  @@map("pipeline_templates")
}

model PipelineStage {
  id         String  @id @default(cuid())
  templateId String
  name       String
  order      Int
  color      String?
  isTerminal Boolean @default(false)

  template     PipelineTemplate        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  submissions  Submission[]
  stageHistory SubmissionStageHistory[]

  @@index([templateId])
  @@map("pipeline_stages")
}

model SubmissionStageHistory {
  id           String   @id @default(cuid())
  submissionId String
  stageId      String
  movedById    String
  movedAt      DateTime @default(now())
  notes        String?

  submission Submission    @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  stage      PipelineStage @relation(fields: [stageId], references: [id])
  movedBy    User          @relation("StageMovedBy", fields: [movedById], references: [id])

  @@index([submissionId])
  @@map("submission_stage_history")
}

model Interview {
  id              String          @id @default(cuid())
  tenantId        String
  submissionId    String?
  candidateId     String
  jobId           String
  type            InterviewType   @default(PHONE_SCREEN)
  scheduledAt     DateTime
  durationMinutes Int             @default(60)
  location        String?
  meetingLink     String?
  status          InterviewStatus @default(SCHEDULED)
  feedback        String?
  rating          Int?
  interviewerName  String?
  interviewerEmail String?
  createdById     String
  createdAt       DateTime        @default(now())

  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  submission Submission? @relation(fields: [submissionId], references: [id])
  candidate  Candidate   @relation(fields: [candidateId], references: [id])
  job        Job         @relation(fields: [jobId], references: [id])
  createdBy  User        @relation("InterviewCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@map("interviews")
}

model Resume {
  id          String   @id @default(cuid())
  tenantId    String
  candidateId String
  fileUrl     String
  fileName    String
  fileSize    Int
  mimeType    String
  parsedData  Json?
  rawText     String?
  isPrimary   Boolean  @default(false)
  uploadedAt  DateTime @default(now())

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([candidateId])
  @@map("resumes")
}

model Attachment {
  id           String   @id @default(cuid())
  tenantId     String
  entityType   String
  entityId     String
  fileUrl      String
  fileName     String
  fileSize     Int
  mimeType     String
  uploadedById String
  uploadedAt   DateTime @default(now())

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation("AttachmentUploadedBy", fields: [uploadedById], references: [id])

  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("attachments")
}

model Activity {
  id         String       @id @default(cuid())
  tenantId   String
  entityType String
  entityId   String
  type       ActivityType
  subject    String?
  body       String?
  metadata   Json?
  createdById String
  createdAt  DateTime     @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation("ActivityCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("activities")
}

model Task {
  id           String      @id @default(cuid())
  tenantId     String
  assignedToId String?
  entityType   String?
  entityId     String?
  title        String
  description  String?
  dueDate      DateTime?
  priority     TaskPriority @default(MEDIUM)
  status       TaskStatus   @default(PENDING)
  createdById  String
  createdAt    DateTime     @default(now())
  completedAt  DateTime?

  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedTo User?  @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  createdBy  User   @relation("TaskCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@index([assignedToId])
  @@map("tasks")
}

model CustomField {
  id              String          @id @default(cuid())
  tenantId        String
  entityType      String
  fieldName       String
  fieldKey        String
  fieldType       CustomFieldType @default(TEXT)
  options         Json?
  isRequired      Boolean         @default(false)
  isFilterable    Boolean         @default(true)
  isVisibleInList Boolean         @default(true)
  displayOrder    Int             @default(0)
  createdAt       DateTime        @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, entityType])
  @@map("custom_fields")
}

model SavedView {
  id         String   @id @default(cuid())
  tenantId   String
  entityType String
  name       String
  isDefault  Boolean  @default(false)
  isShared   Boolean  @default(false)
  config     Json
  createdById String
  createdAt  DateTime @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation("SavedViewCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@index([tenantId, entityType])
  @@map("saved_views")
}

model Notification {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId, isRead])
  @@map("notifications")
}

model InviteToken {
  id          String    @id @default(cuid())
  tenantId    String
  email       String
  role        UserRole  @default(RECRUITER)
  token       String    @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdById String
  createdAt   DateTime  @default(now())

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation("InviteCreatedBy", fields: [createdById], references: [id])

  @@index([tenantId])
  @@index([token])
  @@map("invite_tokens")
}

model RolePermission {
  id          String   @id @default(cuid())
  tenantId    String
  role        UserRole
  permissions Json     // String[] of enabled permission keys
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, role])
  @@index([tenantId])
  @@map("role_permissions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}
